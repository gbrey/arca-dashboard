<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Escenarios - ARCA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .scenario-card {
      transition: all 0.3s ease;
    }
    .scenario-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.12);
    }
    .status-ok { background-color: #d1fae5; color: #065f46; }
    .status-warning { background-color: #fef3c7; color: #92400e; }
    .status-exceeded { background-color: #fee2e2; color: #991b1b; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="simulatorApp()" x-init="init()">
  <!-- Navbar -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center space-x-8">
          <h1 class="text-xl font-bold text-gray-800">ARCA</h1>
          <div class="hidden md:flex items-center space-x-1">
            <a href="/index.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900">
              Dashboard
            </a>
            <a href="/invoices.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900">
              Facturas
            </a>
            <a href="/accounts.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900">
              Cuentas
            </a>
            <a href="/simulator.html" class="px-3 py-2 rounded-md text-sm font-medium bg-purple-100 text-purple-700">
              Simulador
            </a>
            <a href="/recategorization.html" class="px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900">
              Recategorizaci√≥n
            </a>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <select x-model="selectedAccountId" @change="loadSimulation()" class="border rounded px-3 py-1 text-sm">
            <option value="">Seleccionar cuenta</option>
            <template x-for="account in accounts" :key="account.id">
              <option :value="account.id" x-text="(account.is_default ? '‚≠ê ' : '') + account.name"></option>
            </template>
          </select>
          <button @click="logout()" class="text-gray-600 hover:text-gray-800 text-sm">Salir</button>
        </div>
      </div>
      <!-- Men√∫ m√≥vil -->
      <div class="md:hidden border-t pt-2 pb-2">
        <div class="flex space-x-1">
          <a href="/index.html" class="flex-1 text-center px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
            Dashboard
          </a>
          <a href="/invoices.html" class="flex-1 text-center px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
            Facturas
          </a>
          <a href="/accounts.html" class="flex-1 text-center px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
            Cuentas
          </a>
          <a href="/simulator.html" class="flex-1 text-center px-3 py-2 rounded-md text-sm font-medium bg-purple-100 text-purple-700">
            Simulador
          </a>
          <a href="/recategorization.html" class="flex-1 text-center px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-gray-100">
            Recat.
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <div class="gradient-bg text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-3xl font-bold mb-2">Simulador de Escenarios</h1>
      <p class="text-purple-200">Proyecta tu facturaci√≥n y evita sorpresas con el monotributo</p>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 -mt-4">
    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-purple-500 border-t-transparent"></div>
      <p class="mt-4 text-gray-600">Cargando simulaci√≥n...</p>
    </div>

    <!-- No Account Selected -->
    <div x-show="!loading && !selectedAccountId" class="bg-white rounded-xl shadow-lg p-8 text-center">
      <div class="text-6xl mb-4">üìä</div>
      <h2 class="text-xl font-semibold text-gray-800 mb-2">Selecciona una cuenta</h2>
      <p class="text-gray-600">Elige una cuenta ARCA del selector arriba para ver la simulaci√≥n de escenarios.</p>
    </div>

    <!-- Simulation Content -->
    <div x-show="!loading && selectedAccountId && simulation.current" class="space-y-6">
      
      <!-- Current Status Card -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Estado Actual</h2>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div class="text-center p-4 bg-purple-50 rounded-lg">
            <p class="text-sm text-gray-500">Categor√≠a</p>
            <p class="text-3xl font-bold text-purple-600" x-text="simulation.current?.category || '-'"></p>
          </div>
          <div class="text-center p-4 bg-blue-50 rounded-lg">
            <p class="text-sm text-gray-500">Total Facturado</p>
            <p class="text-xl font-bold text-blue-600" x-text="formatCurrency(simulation.current?.total_billed)"></p>
          </div>
          <div class="text-center p-4 bg-green-50 rounded-lg">
            <p class="text-sm text-gray-500">Disponible</p>
            <p class="text-xl font-bold text-green-600" x-text="formatCurrency(simulation.current?.remaining)"></p>
          </div>
          <div class="text-center p-4 bg-orange-50 rounded-lg">
            <p class="text-sm text-gray-500">Promedio Mensual</p>
            <p class="text-xl font-bold text-orange-600" x-text="formatCurrency(simulation.current?.monthly_average)"></p>
          </div>
          <div class="text-center p-4 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-500">Utilizado</p>
            <p class="text-xl font-bold" 
               :class="simulation.current?.percentage >= 90 ? 'text-red-600' : simulation.current?.percentage >= 70 ? 'text-orange-600' : 'text-gray-600'"
               x-text="(simulation.current?.percentage || 0) + '%'"></p>
          </div>
        </div>
      </div>

      <!-- How it Works -->
      <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
        <h3 class="font-semibold mb-2">¬øC√≥mo funciona la ventana m√≥vil?</h3>
        <p class="text-sm text-purple-100">
          El monotributo calcula tu facturaci√≥n de los <strong>√∫ltimos 12 meses</strong>. 
          Cada mes, el monto del mes 13 atr√°s "sale" de la ventana. 
          Por ejemplo, si en enero 2025 facturaste $5M, ese monto deja de contar cuando llegue febrero 2026.
        </p>
      </div>

      <!-- Custom Scenario -->
      <div class="bg-white rounded-xl shadow-lg overflow-hidden border-2 border-pink-400">
        <div class="bg-gradient-to-r from-pink-500 to-rose-500 text-white px-6 py-4">
          <h3 class="font-semibold flex items-center text-lg">
            <span class="mr-2">‚úèÔ∏è</span>
            Escenario Personalizado
          </h3>
          <p class="text-sm text-pink-100">Ingres√° los montos que pens√°s facturar cada mes</p>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <template x-for="(month, idx) in customMonths" :key="idx">
              <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-1" x-text="formatMonth(month.key)"></label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                  <input type="number" 
                         x-model.number="month.amount"
                         @input="calculateCustomScenario()"
                         class="w-full pl-8 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 text-lg font-semibold"
                         placeholder="0"
                         min="0">
                </div>
                <p class="text-xs text-gray-400 mt-1">
                  Sale: <span class="text-red-500" x-text="'-' + formatCurrencyShort(month.exiting)"></span>
                </p>
              </div>
            </template>
          </div>
          
          <!-- Custom Scenario Results -->
          <div x-show="customScenario.projections.length > 0" class="border-t pt-4">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left">
                  <th class="pb-2">Mes</th>
                  <th class="pb-2">Factur√°s</th>
                  <th class="pb-2">Sale</th>
                  <th class="pb-2">Nuevo Total</th>
                  <th class="pb-2">Estado</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="proj in customScenario.projections" :key="proj.month">
                  <tr class="border-t">
                    <td class="py-2 font-medium" x-text="formatMonth(proj.month)"></td>
                    <td class="py-2 text-pink-600 font-semibold" x-text="'+' + formatCurrencyShort(proj.new_amount)"></td>
                    <td class="py-2 text-red-500" x-text="'-' + formatCurrencyShort(proj.exiting_amount)"></td>
                    <td class="py-2 font-bold" x-text="formatCurrencyShort(proj.total)"></td>
                    <td class="py-2">
                      <span class="px-2 py-1 rounded text-xs font-medium"
                            :class="'status-' + proj.status"
                            x-text="proj.category + (proj.exceeds_current ? ' ‚ö†Ô∏è' : '')"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
            
            <!-- Summary -->
            <div class="mt-4 p-4 rounded-lg" 
                 :class="customScenario.exceedsCategory ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'">
              <p class="font-medium" :class="customScenario.exceedsCategory ? 'text-red-700' : 'text-green-700'">
                <span x-show="!customScenario.exceedsCategory">‚úÖ Te manten√©s en categor√≠a <span x-text="simulation.current?.category"></span></span>
                <span x-show="customScenario.exceedsCategory">‚ö†Ô∏è Pasar√≠as a categor√≠a <span x-text="customScenario.newCategory"></span> en <span x-text="formatMonth(customScenario.exceedsMonth)"></span></span>
              </p>
              <p class="text-sm mt-1" :class="customScenario.exceedsCategory ? 'text-red-600' : 'text-green-600'">
                Total proyectado al final: <span class="font-bold" x-text="formatCurrency(customScenario.finalTotal)"></span>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Scenarios Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Conservative Scenario -->
        <div class="scenario-card bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="bg-emerald-500 text-white px-6 py-3">
            <h3 class="font-semibold flex items-center">
              <span class="mr-2">üê¢</span>
              <span x-text="simulation.scenarios?.conservative?.name || 'Conservador'"></span>
            </h3>
            <p class="text-sm text-emerald-100" x-text="simulation.scenarios?.conservative?.description"></p>
          </div>
          <div class="p-6">
            <p class="text-sm text-gray-500 mb-2">Facturaci√≥n mensual proyectada:</p>
            <p class="text-2xl font-bold text-emerald-600 mb-4" x-text="formatCurrency(simulation.scenarios?.conservative?.monthly_amount)"></p>
            
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left">
                  <th class="pb-2">Mes</th>
                  <th class="pb-2">Sale</th>
                  <th class="pb-2">Nuevo Total</th>
                  <th class="pb-2">Estado</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="proj in simulation.scenarios?.conservative?.projections || []" :key="proj.month">
                  <tr class="border-t">
                    <td class="py-2 font-medium" x-text="formatMonth(proj.month)"></td>
                    <td class="py-2 text-red-500" x-text="'-' + formatCurrencyShort(proj.exiting_amount)"></td>
                    <td class="py-2" x-text="formatCurrencyShort(proj.total)"></td>
                    <td class="py-2">
                      <span class="px-2 py-1 rounded text-xs font-medium"
                            :class="'status-' + proj.status"
                            x-text="proj.category"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Normal Scenario -->
        <div class="scenario-card bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="bg-blue-500 text-white px-6 py-3">
            <h3 class="font-semibold flex items-center">
              <span class="mr-2">üìä</span>
              <span x-text="simulation.scenarios?.normal?.name || 'Normal'"></span>
            </h3>
            <p class="text-sm text-blue-100" x-text="simulation.scenarios?.normal?.description"></p>
          </div>
          <div class="p-6">
            <p class="text-sm text-gray-500 mb-2">Facturaci√≥n mensual proyectada:</p>
            <p class="text-2xl font-bold text-blue-600 mb-4" x-text="formatCurrency(simulation.scenarios?.normal?.monthly_amount)"></p>
            
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left">
                  <th class="pb-2">Mes</th>
                  <th class="pb-2">Sale</th>
                  <th class="pb-2">Nuevo Total</th>
                  <th class="pb-2">Estado</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="proj in simulation.scenarios?.normal?.projections || []" :key="proj.month">
                  <tr class="border-t">
                    <td class="py-2 font-medium" x-text="formatMonth(proj.month)"></td>
                    <td class="py-2 text-red-500" x-text="'-' + formatCurrencyShort(proj.exiting_amount)"></td>
                    <td class="py-2" x-text="formatCurrencyShort(proj.total)"></td>
                    <td class="py-2">
                      <span class="px-2 py-1 rounded text-xs font-medium"
                            :class="'status-' + proj.status"
                            x-text="proj.category"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Aggressive Scenario -->
        <div class="scenario-card bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="bg-orange-500 text-white px-6 py-3">
            <h3 class="font-semibold flex items-center">
              <span class="mr-2">üöÄ</span>
              <span x-text="simulation.scenarios?.aggressive?.name || 'Agresivo'"></span>
            </h3>
            <p class="text-sm text-orange-100" x-text="simulation.scenarios?.aggressive?.description"></p>
          </div>
          <div class="p-6">
            <p class="text-sm text-gray-500 mb-2">Facturaci√≥n mensual proyectada:</p>
            <p class="text-2xl font-bold text-orange-600 mb-4" x-text="formatCurrency(simulation.scenarios?.aggressive?.monthly_amount)"></p>
            
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left">
                  <th class="pb-2">Mes</th>
                  <th class="pb-2">Sale</th>
                  <th class="pb-2">Nuevo Total</th>
                  <th class="pb-2">Estado</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="proj in simulation.scenarios?.aggressive?.projections || []" :key="proj.month">
                  <tr class="border-t">
                    <td class="py-2 font-medium" x-text="formatMonth(proj.month)"></td>
                    <td class="py-2 text-red-500" x-text="'-' + formatCurrencyShort(proj.exiting_amount)"></td>
                    <td class="py-2" x-text="formatCurrencyShort(proj.total)"></td>
                    <td class="py-2">
                      <span class="px-2 py-1 rounded text-xs font-medium"
                            :class="'status-' + proj.status"
                            x-text="proj.category"></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Maximum Scenario -->
        <div class="scenario-card bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="bg-purple-600 text-white px-6 py-3">
            <h3 class="font-semibold flex items-center">
              <span class="mr-2">üíé</span>
              <span x-text="simulation.scenarios?.maximum?.name || 'M√°ximo'"></span>
            </h3>
            <p class="text-sm text-purple-200" x-text="simulation.scenarios?.maximum?.description"></p>
          </div>
          <div class="p-6">
            <p class="text-sm text-gray-500 mb-4">M√°ximo facturable por mes sin cambiar de categor√≠a:</p>
            
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left">
                  <th class="pb-2">Mes</th>
                  <th class="pb-2">Sale</th>
                  <th class="pb-2">M√°ximo</th>
                  <th class="pb-2">Total si max</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="proj in simulation.scenarios?.maximum?.projections || []" :key="proj.month">
                  <tr class="border-t">
                    <td class="py-2 font-medium" x-text="formatMonth(proj.month)"></td>
                    <td class="py-2 text-red-500" x-text="'-' + formatCurrencyShort(proj.exiting_amount)"></td>
                    <td class="py-2 font-bold text-purple-600" x-text="formatCurrencyShort(proj.max_facturable)"></td>
                    <td class="py-2" x-text="formatCurrencyShort(proj.total_if_max)"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Projection Chart -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Proyecci√≥n Visual</h2>
        <canvas id="projectionChart" height="120"></canvas>
        <div class="mt-4 flex flex-wrap gap-4 justify-center text-sm">
          <span class="flex items-center"><span class="w-4 h-1 bg-red-400 mr-2" style="border-top: 2px dashed;"></span>L√≠mite</span>
          <span class="flex items-center"><span class="w-4 h-1 bg-emerald-500 mr-2"></span>Conservador</span>
          <span class="flex items-center"><span class="w-4 h-1 bg-blue-500 mr-2"></span>Normal</span>
          <span class="flex items-center"><span class="w-4 h-1 bg-orange-500 mr-2"></span>Agresivo</span>
          <span class="flex items-center"><span class="w-4 h-1 bg-purple-500 mr-2" style="border-top: 2px dashed;"></span>M√°ximo</span>
          <span class="flex items-center"><span class="w-4 h-1 bg-pink-500 mr-2"></span>Personalizado</span>
        </div>
      </div>

      <!-- Category Reference -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Referencia de Categor√≠as</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
          <template x-for="(limit, cat) in simulation.all_categories || {}" :key="cat">
            <div class="p-3 rounded-lg text-center"
                 :class="cat === simulation.current?.category ? 'bg-purple-100 border-2 border-purple-500' : 'bg-gray-50'">
              <p class="text-lg font-bold" :class="cat === simulation.current?.category ? 'text-purple-600' : 'text-gray-700'" x-text="cat"></p>
              <p class="text-xs text-gray-500" x-text="formatCurrencyShort(limit)"></p>
            </div>
          </template>
        </div>
      </div>
    </div>
  </main>

  <script src="/js/simulator.js"></script>
</body>
</html>

